<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Secure File Manager</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button class="logout-btn" onclick="logout()">Logout</button>
  
  <div class="container">
    <h1>üìÅ File Manager Dashboard</h1>
    
    <div class="user-info">
      <p><strong>Welcome, <span id="username"></span>!</strong></p>
      <p>Email: <span id="email"></span></p>
      <p>Role: <span id="role"></span></p>
    </div>
    
    <div id="alert" class="hidden"></div>
    
    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
      <h3>üì§ Click to Upload File</h3>
      <p>Maximum file size: 10MB</p>
      <p>Allowed types: Images, PDF, Documents, ZIP</p>
      <input type="file" id="fileInput" style="display: none;">
    </div>
    
    <div class="file-list">
      <h2>Your Files</h2>
      <div id="filesList"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user'));

    if (!token || !user) {
      window.location.href = 'login.html';
    }

    document.getElementById('username').textContent = user.username;
    document.getElementById('email').textContent = user.email;
    document.getElementById('role').textContent = user.role.toUpperCase();

    document.getElementById('fileInput').addEventListener('change', uploadFile);

    loadFiles();

    async function uploadFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(`${API_URL}/files/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showAlert('File uploaded successfully!', 'success');
          loadFiles();
          document.getElementById('fileInput').value = '';
        } else {
          showAlert(data.error || 'Upload failed', 'error');
        }
      } catch (error) {
        showAlert('Network error. Please try again.', 'error');
      }
    }

    async function loadFiles() {
      try {
        const response = await fetch(`${API_URL}/files/my-files`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          displayFiles(data.files);
        } else {
          showAlert('Failed to load files', 'error');
        }
      } catch (error) {
        showAlert('Network error', 'error');
      }
    }

    function displayFiles(files) {
      const filesList = document.getElementById('filesList');
      
      if (files.length === 0) {
        filesList.innerHTML = '<p style="text-align: center; color: #999;">No files uploaded yet</p>';
        return;
      }

      filesList.innerHTML = files.map(file => `
        <div class="file-item">
          <div class="file-info">
            <h3>${file.filename}</h3>
            <p>Size: ${formatBytes(file.size)} | Uploaded: ${new Date(file.uploadedAt).toLocaleDateString()}</p>
            <p>Owner: ${file.owner.username}</p>
          </div>
          <div class="file-actions">
            <button class="btn-success" onclick="downloadFile('${file._id}', '${file.filename}')">Download</button>
            <button class="btn-success" onclick="shareFile('${file._id}')">Share</button>
            ${file.owner._id === user.id || user.role === 'admin' ? 
              `<button class="btn-danger" onclick="deleteFile('${file._id}')">Delete</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function downloadFile(fileId, filename) {
      try {
        const response = await fetch(`${API_URL}/files/download/${fileId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          showAlert('File downloaded successfully!', 'success');
        } else {
          showAlert('Download failed', 'error');
        }
      } catch (error) {
        showAlert('Network error', 'error');
      }
    }

    async function shareFile(fileId) {
      const email = prompt('Enter email address to share with:');
      if (!email) return;

      const permission = confirm('Give write permission? (Cancel for read-only)') ? 'write' : 'read';

      try {
        const response = await fetch(`${API_URL}/files/share/${fileId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userEmail: email, permission })
        });

        const data = await response.json();

        if (response.ok) {
          showAlert('File shared successfully!', 'success');
        } else {
          showAlert(data.error || 'Sharing failed', 'error');
        }
      } catch (error) {
        showAlert('Network error', 'error');
      }
    }

    async function deleteFile(fileId) {
      if (!confirm('Are you sure you want to delete this file?')) return;

      try {
        const response = await fetch(`${API_URL}/files/delete/${fileId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          showAlert('File deleted successfully!', 'success');
          loadFiles();
        } else {
          showAlert('Delete failed', 'error');
        }
      } catch (error) {
        showAlert('Network error', 'error');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 5000);
    }
  </script>
</body>
</html>
